# 【基础】HTTP协议的原理及应用

## 前言
HTTP 非常重要和基础

## 经典网络五层模型
![经典网络五层模型](https://upload-images.jianshu.io/upload_images/13548275-88019f07df712ac2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/600/format/webp)

在每台计算机设备上，都有这么一套系统链路的关系，来保证网络传输的正常进行，因为统一集成了这么一套经典模型，所以自己使用的计算机也是可以作为一台服务器来提供网络服务的。

### 应用层：
应用层包含了我们所说的 `HTTP` 协议，为各个应用软件提供了很多服务，常见的应用层服务有：`HTTP` 服务 、`FTP` 服务 、`Email` 服务`HTTP` 等。应用层屏蔽了底层模型的相关细节，作为应用支持，只提供给使用者一些必要的使用方式。

### 传输层
传输层作为为应用层的基础，定义了“端到端（end to end）”之间数据间的传输方式，比如：两台设备如何建立连接？设备之间需要以何种规范进行数据传输？需要以什么方式进行数据的分片、重组、拼接？这些都是传输层为我们定义好的。
常见的传输层协议有 `TCP/IP` 和 `UDP`。`TCP/IP` 协议是目前网络模型中比较重要的协议，常见的应用服务，比如 `HTTP` 服务 、`FTP` 服务 、`Email` 服务，它们都是基于 `TCP/IP` 实现的。
如果是对于实时性要求比较高的应用，比如直播、LOL 等对战游戏，则会基于`UDP` 协议实现，相对于 `TCP/IP`，`UPD` 的可靠性要差一些，在网络不好的情况下很容易出现丢包的情况。

### 网络层
网络层为数据在结点之间传输创建逻辑链路，当我们在浏览器敲下域名，浏览器在网络里如何通过这个域名，找到对应的 `IP` 映射，这个查询的逻辑关系和链路，是网络层规范和定义的。

### 数据链路层
数据链路层在通信实体间建立数据链路连接，物理设备连接完成以后，需要相应的软件和驱动来连接和打通这些物理设备，创建电路的连接。

### 物理层：
定义物理设备如何传输数据，常见的物理层有网线，光缆，网卡，声卡等，物理层是一切软件的基础。

## HTTP 服务的简单应用
- 浏览器输入网页 `url` 打开网页
- `Ajax` 动态获取数据
- `img.src` 等静态资源的获取

> 从在浏览器 url 地址栏输入回车到页面渲染完成的一张流程图，
> 每一个节点就是 HTTP 做的一件重要的事情，开发者可以根据每个节点，进行优化从而达到性能的提升。

浏览器控制台里有一个选项 `performence` ，它会为我们记录 HTTP 请求发起到页面渲染完成这段过程中的每一个过程点，在 HTTP 请求和浏览器渲染的过程中存在着时间的消耗，这个 `performence`，可以为我们记录每个时间点上所消耗的时间。
对于开发者来说，我们通过 `performence` 记录的过程节点，就可以清楚地看到哪个过程耗时比较长，就可以有针对地进行优化。

## 访问网页时发生了什么
1. 用户在浏览器地址栏中输入对应网址的 `url` 然后回车。
2. 浏览器会首先判断是否需要 `redirect`。
3. 浏览器去 `app-cache` 中查找是否有缓存，如果有，则查找本地缓存；否则需要继续去服务器请求对应文件。
4. 因为用户输入的是域名，每个域名都需要映射到一台服务器的 `IP` 地址，客户端需要拿到对应服务器的 `IP` 才能进行后续的连接与请求。如果本地没有记录过这个域名和 `IP` 的映射，客户端就需要去对应的域名供应商哪里去获取服务器 `IP` ，这个过程叫做 `DNS 解析`。
5. 浏览器从域名供应商那里获取到了服务器对应 `IP`，就会向服务器发送 `TCP` 连接请求，服务器收到请求后回应，双方确认后建立起 `TCP 双向连接`。从客户端发起连接请求一直到 `TCP` 连接建立，这个过程，叫做 `三次握手`。
6. 如果请求是 HTTPS 的，还需要创建一个额外的 HTTPS 的安全连接来保证数据传输的安全。
7. 连接创建完成，浏览器开始向服务端发送 HTTP 请求的数据包，服务端接受请求，对请求进行解析，经过数据操作后，返回客户端需要的数据包。
8. 客户端接收到服务端返回的数据包，开始页面的渲染。至此，一次 HTTP 请求完成。

## HTTP 协议发展历史
### HTTP 0.9 版本
- 只有一个 `GET` 命令
- 没有请求头和相应头来描述传输相关的数据信息
- 服务器发送完数据后，直接关闭 `TCP` 连接
> 注意：`HTTP` 请求和 `TCP` 连接是不一样的，`HTTP` 是在 `TCP/IP` 连接建立的基础上而发起的传输请求，在同一个 `TCP/IP` 连接通道下，可以发送多个 `HTTP` 请求，举个例子的话就是高速公路和车子的关系。

### HTTP 1.0 版本
- 增加了很多命令，`HEAD`、`POST`、`PUT`、`DELETE` 等。
- 增设了 `status code` 状态码和 `header` 请求头和响应头。
- 增加了多字符集支持、多部分发送、权限、缓存等。

### HTTP 1.1 （目前普遍使用）
- 默认支持持久连接
- 增加了 `pipeline` ，允许并行处理请求
- 增加了 `host` 请求头字段，通过对 `host` 解析，就能够允许在同一台物理服务器上运行多个软件服务，极大提高了服务器的使用率。目前的 `nginx` 反向代理就是根据 `HTTP` 请求头中的 `host` 来分辨不同的请求，从而将这些请求代理到同一台服务器不同的软件服务上。
> HTTP是基于 `TCP/IP` 协议的，创建一个 `TCP` 连接是需要经过三次握手，有比较大的开销，如果每次通讯都要重新建立连接的话，对性能有影响。因此最好能维持一个长连接，可以用个长连接来发送多个请求。

### HTTP 2
- 使用二进制的数据传输方式来替代 `HTTP 1` 中的字符串数据传输方式。
- 所有数据以“帧”的方式进行传输，因此同一个连接中发送的多个请求不再需要按照顺序进行返回处理，可以达到并发的数据传输。
- 压缩头信息进行传输数据量的优化。
- 新增了推送的概念，服务端可以主动发起一些数据推送。比如，服务端在接收到浏览器发来的 `HTML` 请求的同时，可以主动推送相关的资源文件（js/css）给客户端，并行发送，提高网页的传输和渲染效率。
> HTTP 2 的升级，主要是为了解决 HTTP 1 中存在的性能瓶颈而做的一些调整和优化。

### HTTPS
HTTPS 是一个安全版的 HTTP1.1 ，关于更多的 HTTPS 的细节，详见下文。

## HTTP 请求

## HTTP 缓存

## HTTP 请求头

## HTTP 响应头

## CORS 实现跨域

## HTTPS

## HTTPS 的创建过程

## 为什么 HTTPS 是相对安全的

## 什么是长链接，为什么需要长链接

## HTTPS 的信道复用及性能优化

## TCP 

## 三次握手

